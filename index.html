<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SRRA Snack Bar Inventory Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-5xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <h1 class="text-2xl font-bold mb-2">SRRA Snack Bar Inventory Management</h1>
    <div class="mb-4 text-sm text-gray-700">
      <p><strong>Instructions:</strong></p>
      <ul class="list-disc pl-5">
        <li>At the start of the season, edit "Initial Stock #" for each product to set the starting inventory, then click "Save Daily Sales" to save.</li>
        <li>Edit "Low Stock Trigger" to set the threshold for restock alerts.</li>
        <li>Enter the number of items sold today in the "Sold Today" column.</li>
        <li>Click "Save Daily Sales" to update stock, totals, thresholds, last restock dates, initial stock, and email a CSV to treasurer@sideburnrun.com.</li>
        <li>Enter restock quantities in "Restock Amount" and click "Restock Update" to add to current stock.</li>
        <li>Edit "Last Restock Date" to record the last restock date using the calendar picker.</li>
        <li>Use "Reset Daily Sales" to clear unsaved "Sold Today" entries (export data first to save progress).</li>
        <li>Use "Reset Grand Totals" to reset "Grand Total Sold" to zero (export data first, as this cannot be undone).</li>
        <li>Click "Export Data" to download a CSV file (inventory_backup.csv) for backup, viewable in Excel or Google Sheets.</li>
        <li>Click "Import Data" to upload a previously exported CSV file to restore inventory data.</li>
        <li>Note: Low stock alerts and CSV data (on Save Daily Sales) are emailed to treasurer@sideburnrun.com.</li>
      </ul>
    </div>
    <div class="mb-4">
      <button id="saveSales" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save Daily Sales</button>
      <button id="restockUpdate" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 ml-2">Restock Update</button>
      <button id="resetSales" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 ml-2">Reset Daily Sales</button>
      <button id="resetGrandTotals" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 ml-2">Reset Grand Totals</button>
      <button id="exportData" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 ml-2">Export Data</button>
      <button id="importData" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 ml-2">Import Data</button>
      <input type="file" id="fileInput" class="hidden" accept=".csv">
    </div>
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-2">Row</th>
          <th class="border p-2">Product</th>
          <th class="border p-2">Initial Stock #</th>
          <th class="border p-2">Sold Today</th>
          <th class="border p-2">Current Stock</th>
          <th class="border p-2">Low Stock Trigger</th>
          <th class="border p-2">Restock Status</th>
          <th class="border p-2">Restock Amount</th>
          <th class="border p-2">Last Restock Date</th>
          <th class="border p-2">Grand Total Sold</th>
        </tr>
      </thead>
      <tbody id="inventoryTable"></tbody>
    </table>
    <div id="restockMessage" class="mt-4 p-4 bg-yellow-100 rounded hidden"></div>
  </div>

  <script>
    // Initialize EmailJS with your public key
    emailjs.init("CSVhRre_5AKhQKHFl");

    // Initial inventory data (exactly 5 items)
    const initialInventory = [
      { id: 1, name: "Candy Bar", stock: 50, initialStock: 50, threshold: 10, salesHistory: [], totalSold: 0, restockDate: "" },
      { id: 2, name: "Soda Can", stock: 60, initialStock: 60, threshold: 10, salesHistory: [], totalSold: 0, restockDate: "" },
      { id: 3, name: "Ice Cream Bar", stock: 40, initialStock: 40, threshold: 10, salesHistory: [], totalSold: 0, restockDate: "" },
      { id: 4, name: "Chips", stock: 45, initialStock: 45, threshold: 10, salesHistory: [], totalSold: 0, restockDate: "" },
      { id: 5, name: "Water Bottle", stock: 70, initialStock: 70, threshold: 10, salesHistory: [], totalSold: 0, restockDate: "" }
    ];

    // Load or initialize inventory (ensure only 5 items)
    let inventory = JSON.parse(localStorage.getItem('inventory')) || initialInventory;
    if (inventory.length !== initialInventory.length || inventory.some((item, i) => item.id !== initialInventory[i].id)) {
      inventory = initial revokeObjectURL(url);
    }

    // Import data from CSV
    document.getElementById('importData').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const csvText = e.target.result;
            const lines = csvText.trim().split('\n').map(line => line.split(',').map(cell => cell.replace(/^"|"$/g, '').replace(/""/g, '"')));
            const headers = lines[0];
            const expectedHeaders = ['id', 'name', 'stock', 'initialStock', 'threshold', 'salesHistory', 'totalSold', 'restockDate'];
            if (headers.length !== expectedHeaders.length || !headers.every((h, i) => h === expectedHeaders[i])) {
              alert('Invalid CSV format. Please use a valid inventory CSV file.');
              return;
            }
            const importedInventory = lines.slice(1).map(line => ({
              id: parseInt(line[0]),
              name: line[1],
              stock: parseInt(line[2]),
              initialStock: parseInt(line[3]),
              threshold: parseInt(line[4]),
              salesHistory: line[5] ? line[5].split(',').map(Number).filter(n => !isNaN(n)) : [],
              totalSold: parseInt(line[6]),
              restockDate: line[7] || ''
            }));
            if (importedInventory.length === initialInventory.length &&
                importedInventory.every((item, i) => item.id === initialInventory[i].id)) {
              inventory = importedInventory;
              localStorage.setItem('inventory', JSON.stringify(inventory));
              renderTable();
              alert('Data imported successfully!');
            } else {
              alert('Imported CSV does not match the 5-item inventory structure.');
            }
          } catch (error) {
            alert('Error importing data. Please ensure the file is a valid CSV.');
          }
        };
        reader.readAsText(file);
      }
    });

    // Initial render
    renderTable();
  </script>
</body>
</html>